#!/bin/bash -e

# Get last argument (the user@hostname)
for LAST; do true; done
REMOTEHOST=$(echo $LAST|sed 's/^.*@//')

USE_RSYNC=
while read -r line; do
    printf "%s\n" "$line"
    [[ $line == __EB_USE_RSYNC__ ]] && USE_RSYNC=1
done < <(ssh $LAST /bin/bash <<'EOF'
if [[ -h ~/.bashrc && $(readlink ~/.bashrc) == *skel* ]]; then
    x=$(readlink ~/.bashrc)
    rm -f ~/.bashrc
    cp "$x" ~/.bashrc
fi
grep EXTRA_BASHRC ~/.bashrc >/dev/null || \
    grep eb-dotfiles/bashrc ~/.bashrc >/dev/null || \
    echo '[[ -n $EXTRA_BASHRC ]] && source ~/$EXTRA_BASHRC' >>~/.bashrc
if [[ -x $(which git) && -x $(which perl) ]]; then
    if [[ -d ~/.eb-dotfiles/.git ]]; then
        (
            cd ~/.eb-dotfiles;
            git pull --recurse-submodules=on-demand
            git submodule sync
            git submodule update --init --recursive
        )
    else
        git clone --recurse-submodules https://github.com/borsboom/dotfiles.git ~/.eb-dotfiles
        (
            cd .eb-dotfiles
            git config user.name "Emanuel Borsboom"
            git config user.email emanuel@borsboom.io
        )
    fi
else
    echo __EB_USE_RSYNC__
fi
EOF
)

if [[ -n $USE_RSYNC ]]; then
    rsync -av ~/.eb-dotfiles/ $LAST:.eb-dotfiles/
fi

function cleanup_mount() {
    umount  ~/mnt/$REMOTEHOST || true
    rmdir ~/mnt/$REMOTEHOST || true
}
if [[ -d ~/mnt/$REMOTEHOST ]]; then
    echo
    echo -n "~/mnt/$REMOTEHOST already exists.  Re-mount? [y/N] "
    read REMOUNT
    [[ $REMOUNT == [yY]* ]] && cleanup_mount
fi
if ! [[ -d ~/mnt/$REMOTEHOST ]]; then
    mkdir -p ~/mnt/$REMOTEHOST
    sshfs $LAST: ~/mnt/$REMOTEHOST \
        -oauto_cache,reconnect,defer_permissions,noappledouble,negative_vncache,volname=sshfs-$REMOTEHOST
    trap cleanup_mount 0
fi

DO_START=y
while [[ $DO_START != [nN]* ]]; do
    ssh -t -R 52698:localhost:52698 "$@" \
            EXTRA_BASHRC='.eb-dotfiles/bashrc' \
            EB_WINDOW_TITLE="$REMOTEHOST" \
            '/bin/bash -li ~/.eb-dotfiles/bash-session' \
        || true
    echo
    echo -n "Reconnect session? [Y/n] "
    read DO_START
done
